{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load markup %}
{% load searchtags %}
{% load block_helper %}

{% block nav_makerequest %}active{% endblock %}

{% block foisite_advice %}
  {% include "foisite/banner.html" %}
{% endblock %}

{% block body %}
<div class="row justify-content-lg-center">
  <div class="col-lg-8">
    {% if public_body %}
      <form method="post" action="{% url 'foirequest-submit_request' public_body=public_body.slug %}" id="make-request" novalidate>
    {% else %}
      <form method="post" action="{% url 'foirequest-submit_request' %}" id="make-request" novalidate>
    {% endif %}

    {% csrf_token %}
    {{ request_form.reference }}
    {{ request_form.redirect_url}}

    {% if public_body %}
      <p>
        <strong>{{ public_body.name }}</strong>
        ({{ public_body.jurisdiction.name }})
      </p>
      {% if public_body.request_note or public_body.default_law.request_note %}
        <div id="request-note" class="panel panel-danger">
          <div class="panel-heading">
            <h3 class="panel-title">
              {% trans "Notes for this public body" %}
            </h3>
          </div>
          <div class="panel-body">
            {% if public_body.default_law.request_note %}
              {{ public_body.default_law.request_note|markdown }}
            {% endif %}
            {% if public_body.request_note %}
              {{ public_body.request_note|markdown }}
            {% endif %}
          </div>
        </div>
      {% endif %}
    {% endif %}

    {% comment %}
    {% if not request_form.is_bound and not request_form.initial.subject and not request.user.is_authenticated %}
      {% include "foirequest/request/purpose_check.html" %}
    {% endif %}
    {% endcomment %}
      <request-form
        publicbody-default-search="{{ public_body_search }}"
        user-json="{{ request.user.as_json }}"
        publicbody-json="{{ public_body.as_json }}"
        user-form-json="{{ user_form.as_json }}"
        request-form-json="{{ request_form.as_json }}"
        show-similar="1"
        :config="config">

        <legend slot="publicbody-legend-title">
          {% blocktrans %}Choose a Public Body{% endblocktrans %}
        </legend>

        <legend slot="request-legend-title">
          {% blocktrans %}Write the Request{% endblocktrans %}
        </legend>

        <div slot="requesthints" class="panel panel-default">
          <div class="panel-body">
            <h5>
              {% blocktrans %}Important Notes:{% endblocktrans %}
            </h5>
            <ul>
              <li>
                {% blocktrans %}Write your request in <strong>simple, precise language</strong>.{% endblocktrans %}
              </li>
              <li>
                {% blocktrans %}Ask for <strong>specific</strong> documents or information.{% endblocktrans %}
              </li>
              <li>
                {% blocktrans %}Keep it <strong>focused and concise</strong>.{% endblocktrans %}
              </li>
              <li>
                {% blocktrans %}This site is <strong>public</strong>. Everything you type and any response will be published.{% endblocktrans %}
              </li>
              <li>
                {% blocktrans %}Do <strong>not include</strong> personal information in your request.{% endblocktrans %}
              </li>
              <li>
                {% blocktrans %}Do <strong>not ask</strong> for personal information.{% endblocktrans %}
              </li>
            </ul>
          </div>
        </div>
        <div slot="public">
          {{ request_form.hide_public }}
          {% if request_form.hide_public.value %}
            <div style="display: none">
              {{ request_form.public }}
            </div>
          {% else %}
            <div class="card">
              <div class="card-body">
                <div class="checkbox">
                  <label>
                    {{ request_form.public }}
                    {{ request_form.public.label }}
                  </label>
                  <p class="help-block">
                    {{ request_form.public.help_text }}
                  </p>
                </div>
              </div>
            </div>
          {% endif %}
        </div>
      </request-form>
    </form>
  </div>
</div>

{% include "publicbody/widget/_add_js_vars.html" %}

{% addtoblock "js" %}
  <script type="text/javascript">
    var Froide = window.Froide || {}
    Froide.settings = Froide.settings || {}
    Froide.settings.user_can_hide_web = parseInt('{% if froide.user_can_hide_web %}1{% else %}0{% endif %}', 10)
    Froide.url = Froide.url || {}
    Froide.url.searchRequests = "{% url 'api_get_simple_search' api_name='v1' resource_name='request' %}"

    Froide.i18n = Froide.i18n || {}
    Froide.i18n = Object.assign(Froide.i18n, {
      subject: '{% trans "Subject" %}',
      submitRequest: '{% trans "Submit Request"%}',

      yourFirstName: '{% trans "Your first name" %}',
      yourEmail: '{% trans "Your email address" %}',
      yourAddress: '{% trans "Your postal address" %}',

      similarExist: '{% trans "Please make sure the information is not already requested or public" %}',
      similarRequests: '{% trans "Similar requests" %}',
      relevantResources: '{% trans "Relevant resources" %}'
    })

    Froide.template = Froide.template || {}
    Froide.template.visitPublicBodyWebsite = '{% blocktrans %}Visit the website of this Public Body{% endblocktrans %}'
    Froide.regex = Froide.regex || {}
    Froide.regex.greetings = [new RegExp('{% blocktrans %}Dear Sir or Madam{% endblocktrans %}', 'gi')]
    Froide.regex.closings = [new RegExp('{% blocktrans %}Kind Regards{% endblocktrans %}', 'gi')]

    Froide.template.searchInternet = '<li class="search-internet"><a href="{% templatetag openvariable %}url{% templatetag closevariable %}" target="_blank">{% trans "Search the internet for information about:" %} {% templatetag openvariable %}query{% templatetag closevariable %}</a></li>'
    Froide.template.searchPublicBodyWebsite = '<li class="search-public-body-website"><a href="{% templatetag openvariable %}url{% templatetag closevariable %}" target="_blank">{% trans "Search Public Body Website" %}</a></li>'
    Froide.template.searchEngineUrl = '{% search_engine_query %}'
    Froide.template.foundEmail = '{% trans "We found an email address in your text: {{ email }}. Do not sent personal data to the Public Body." %}'
    Froide.template.foundGreeting = '{% trans "We found {{ find }} in your text, but there is already a greeting at the top of the letter!" %}'
    Froide.template.foundClosing = '{% trans "We found {{ find }} in your text, but there is already a closing at the bottom of the letter!" %}'
    Froide.template.emptyBody = "{% blocktrans %}Don't leave the body of your message empty{% endblocktrans %}"
    Froide.template.emptySubject = "{% blocktrans %}Don't leave the subject of your message empty{% endblocktrans %}"
  </script>
  <script src="{% static 'js/makerequest.js' %}" charset="utf-8"></script>
  <script>
    /* eslint-disable no-undef */
    Froide.components.makerequest.createRequestForm('#make-request', Froide)
  </script>
{% endaddtoblock %}

{% endblock %}
