{% extends 'foirequest/base.html' %}
{% load url from future %}
{% load i18n %}
{% load markup %}
{% load comments %}
{% load foirequest_tags %}

{% block title %}{{ object.title }}{% endblock %}

{% block metadescription %}{{ object.description }}{% endblock %}


{% block extra_head %}
<link href="{% url 'foirequest-feed' slug=object.slug %}" rel="alternate nofollow" type="application/rss+xml" title="{% blocktrans with title=object.title %}RSS Feed for request '{{ title }}'{% endblocktrans %}">
<link rel="alternate nofollow" type="application/atom+xml" title="{% blocktrans with title=object.title %}Atom feed for request '{{ title }}'{% endblocktrans %}" href="{% url 'foirequest-feed_atom' slug=object.slug %}" /> 

{% endblock %}

{% block body %}
<h2>{{ object.title }}</h2>
<div class="span-18">
<dl>
  <dt>{% blocktrans %}Request to:{% endblocktrans %}</dt>
  <dd>{% if object.public_body %}
  <a href="{{ object.public_body.get_absolute_url }}">{{ object.public_body.name }}</a>
  {% else %}
  {% blocktrans %}Not yet known{% endblocktrans %}
  {% endif %}</dd>
  {% if object.law %}
  {% if object.law.meta %}
  <dt>{% blocktrans %}Laws used:{% endblocktrans %}</dt>
  <dd>
    <ul>
    {% for law in object.law.combined.all %}
      <li>
        <a href="{% url 'publicbody-foilaw-show' slug=law.slug %}" class="target-new">{{ law.name }}</a>
      </li>
    {% endfor %}
    </ul>
  </dd>
  {% else %}
    <dt>{% blocktrans %}Law used:{% endblocktrans %}</dt>
    <dd><a href="{% url 'publicbody-foilaw-show' slug=object.law.slug %}" class="target-new">{{ object.law.name }}</a>
    </dd>
  {% endif %}
  {% else %}
    <dt>{% blocktrans %}Law used:{% endblocktrans %}</dt>
    <dd>{% blocktrans %}Not yet set{% endblocktrans %}</dd>
  {% endif %}
  <dt>{% blocktrans %}Status of this request:{% endblocktrans %}</dt>
  <dd>{{ object.readable_status }}</dd>
  {% if object.awaits_response %}
    <dt>{% blocktrans %}Due date:{% endblocktrans %}</dt>
  {% if object.is_overdue %}
  <dd class="red">
  {{ object.due_date|date:"DATE_FORMAT" }} - {% blocktrans with due=object.due_date|timesince %}{{ due }} ago{% endblocktrans %}
  {% else %}
    <dd>{{ object.due_date|date:"DATE_FORMAT" }} - {% blocktrans with due=object.due_date|timeuntil %}in {{ due }}{% endblocktrans %}
    {% endif %}
    (<a href="{% url 'help-foi_officers' %}#frist">{% blocktrans %}Details{% endblocktrans %}</a>)
    </dd>
  {% endif %}
{% if object.refusal_reason %}
  <dt>{% blocktrans %}Refusal Reason{% endblocktrans %}</dt>
  <dd>{{ object.refusal_reason }}</dd>
{% endif %}
{% if object.costs > 0 %}
  <dt>{% blocktrans %}Cost of information:{% endblocktrans %}</dt>
  <dd>{{ object.costs|floatformat:2 }} {{ froide.currency }}</dd>
  {% endif %}
{% if object.description %}
  <dt>{% blocktrans %}Summary of Request{% endblocktrans %}</dt>
  <dd>{{ object.get_description|urlize|linebreaks }}</dd>
  {% endif %}
{% if object.resolution %}
  <dt>{% blocktrans %}Summary of Resolution{% endblocktrans %}</dt>
  <dd>{{ object.resolution|urlize|linebreaks }}</dd>
{% endif %}

</dl>
{# Public Body Needed #}
{% if object.status == "publicbody_needed" %}
<div class="info">
  {% blocktrans %}This request was not sent yet, because it still needs a Public Body as a recipient.{% endblocktrans %}
</div>
{% if not object.public %}
<div class="notice">
  {% blocktrans %}This request is not public and will not receive suggestions for public bodies from users!{% endblocktrans %}
</div>
{% endif %}
{% endif %}
{# Unconfirmed Public Body #}
{% if object.public_body and not object.public_body.confirmed %}
<div class="notice">
  {% blocktrans %}The public body of this request has been created by the user and still needs to be confirmed.{% endblocktrans %}
</div>
{% endif %}
{# End Unconfirmed Public Body #}

<hr/>
<h4 id="messages">{% blocktrans %}Messages in this request{% endblocktrans %}</h4>

{% for message in object.messages %}
<div id="{{ message.get_html_id }}" class="message-container">
  <div class="message{% if not message.sender_user %} message-received{% endif %}{% if message.is_postal %} message-postal{% endif %}">
  <table class="message-table">
    <tbody>
    <tr>
      <td class="key">{% blocktrans %}From{% endblocktrans %}</td>
      {% if object.user == user %}
      <td>{{ message.real_sender }}</td>
      {% else %}
      <td>{{ message.sender }}</td>
      {% endif %}
    </tr>
    <tr>
      <td class="key">{% blocktrans %}Subject{% endblocktrans %}</td>
      <td><strong>{{ message.subject }}</strong></td>
    </tr>
    <tr>
      <td class="key">{% blocktrans %}Date{% endblocktrans %}</td>
      {% if message.is_postal %}
      <td>{{ message.timestamp|date:"DATE_FORMAT" }}</td>
      {% else %}
      <td>{{ message.timestamp|date:"DATETIME_FORMAT" }}</td>
      {% endif %}
    </tr>
    {% if message.all_attachments %}
    <tr>
      <td class="key">{% blocktrans %}Attachments{% endblocktrans %}</td>
    <td>
      <ul>
    {% for attachment in message.all_attachments %}
    <li>
    <a href="{{ attachment.file.url }}">{{ attachment.name }} ({{ attachment.size|filesizeformat }})</a>{% if attachment.can_preview %} - <a class="target-new" href="{{ attachment.get_preview_url }}">{% blocktrans %}Preview in Browser{% endblocktrans %}</a>{% endif %}
    </li>
    {% endfor %}
  </ul>
    </td>
  </tr>
  {% endif %}
  {% if user == object.user and message.is_postal %}
  <tr>
    <td class="key">{% blocktrans %}Upload Attachments{% endblocktrans %}</td>
    {% with form=message.get_postal_attachment_form %}
    <td>
      <form method="post" action="{% url 'foirequest-add_postal_reply_attachment' slug=object.slug message_id=message.pk %}" enctype="multipart/form-data">{% csrf_token %}
      {{ form.scan }}
      <input type="submit" value="{% blocktrans %}Upload Document{% endblocktrans %}"/><br/>
      {{ form.scan.help_text }}
    </td>
    {% endwith %}
  {% endif %}
  </tbody>
  </table>
  <hr/>
  {% if forloop.counter0 == 0 %}
  <div class="message-content">{% highlight_request message %}</div>
  {% else %}
  {% if user == object.user %}
  <div class="message-content">{{ message.get_real_content|urlize }}</div>
  {% else %}
  <div class="message-content">{{ message.get_content|urlize }}</div>
  {% endif %}
  {% endif %}
</div>
{% if message.events %}
<div class="events">
  <ol>
  {% for event in message.events %}
  <li class="event" id="{{ event.get_html_id }}"><span title="{{ event.timestamp }}">{% blocktrans with time=event.timestamp|timesince %}{{ time }} ago{% endblocktrans %}</span>: {{ event.as_html }}</li>
  {% endfor %}
  </ol>
</div>
{% endif %}
<div class="comments-container">
  {% get_comment_list for message as comment_list %}
  <a class="toggle" href="#comments-{{ message.id }}">{% blocktrans count count=comment_list|length %}Show {{ count }} comment / Write a comment{% plural %}Show {{ count }} comments / Write a comment{% endblocktrans %}</a>
<div id="comments-{{ message.id }}" class="comments">
  {% include "comments/foirequest/list.html" %}
  {% if user.is_authenticated %}
  {% with next=object.get_absolute_url %}
    {% render_comment_form for message %}
  {% endwith %}
  {% else %}
  <a href="{% url 'account-login' %}">{% blocktrans %}Please login to write a comment.{% endblocktrans %}</a><br/>
  {% endif %}
<a class="toggle" href="#comments-{{ message.id }}">{% blocktrans %}Hide comments{% endblocktrans %}</a>
</div>
</div>
</div>
{% empty %}
<p>{% blocktrans %}No messages yet{% endblocktrans %}</p>
{% endfor %}

{# Public Body Needed #}
{% if object.status == "publicbody_needed" %}
<div class="section">
  <p>{% blocktrans %}You can suggest a public body for this request.{% endblocktrans %}
  {% with suggestions=object.public_body_suggestions %}
  {% if suggestions %}
  <br/>{% blocktrans %}The following public bodies have already been suggested:{% endblocktrans %}
  {% endif %}
  </p>
      <ul>
      {% for suggestion in suggestions %}
      <li><strong>{{ suggestion.public_body.name }}</strong> - <a href="{{ suggestion.public_body.get_absolute_url }}" class="info-link">{% blocktrans %}Details{% endblocktrans %}</a>{% if suggestion.reason %}<br/>
      {% blocktrans %}Reason given by the user:{% endblocktrans %} {{ suggestion.reason }}
      {% endif %}
      </li>
      {% empty %}
        <li>{% blocktrans %}There are no suggestions yet{% endblocktrans %}</li>
      {% endfor %}
      </ul>
  {% endwith %}
  <form method="post" action="{% url 'foirequest-suggest_public_body' slug=object.slug %}">
    {% csrf_token %}
    {% include "publicbody/_chooser.html" %}
    {% with form=object.make_public_body_suggestion_form %}
    {{ form.reason.label_tag }} {{ form.reason }}
    {% endwith %}
    <br/><input type="submit" value="{% blocktrans %}Suggest this Public Body{% endblocktrans%}"/>
  </form>
</div>

{% if object.user == user %}
{% with suggestions_form=object.public_body_suggestions_form %}
  {% if suggestions_form %}
  <div class="section important-form">
    <p>{% blocktrans %}As the author of this request, please choose a public body from one of the suggestions:{% endblocktrans %}</p>
    <form method="post" action="{% url 'foirequest-set_public_body' slug=object.slug %}">
      {% csrf_token %}
      {{ suggestions_form }}
      <input type="submit" value="{% blocktrans %}Send this request to the selected Public Body{% endblocktrans %}"/>
    </form>
  </div>
  {% endif %}
  {% endwith %}
{% endif %}
{% endif %}
{# End Public Body Needed #}

{# Set status #}
{% if object.user == user and object.status_settable %}
<div class="section important-form">
  <form method="post" action="{% url 'foirequest-set_status' slug=object.slug %}">{% csrf_token %}
    <label for="id_status">{% blocktrans %}Current status of request:{% endblocktrans %}</label><br/>
    {{ object.status_form.status }}<br/>
    {% if froide.payment_possible %}
    <div class="status-payment status-section">{% blocktrans %}Please specify what the Public Body charges for the information.{% endblocktrans %}<br/>
      <label id="id_costs">{% blocktrans %}Costs:{% endblocktrans %} </label>
      {{ object.status_form.costs }} {{ froide.currency }}
    </div>
    {% endif %}
    <div class="status-refusal status-section">
  {% blocktrans %}When you are denied information, the Public Body should always state the reason.{% endblocktrans %}<br/>
      <label id="id_refusal_reason">{% blocktrans %}Refusal Reason: {% endblocktrans %}</label>
      {{ object.status_form.refusal_reason }}
    </div>
    <input type="submit" value="{% blocktrans %}Set status{% endblocktrans %}"/>
    </p>
  </form>
</div>
{# End Set status #}

{# If Meta Law #}
{% if object.user == user and object.status_settable and object.law.meta %}
<div class="section">
  <form method="post" action="{% url 'foirequest-set_law' slug=object.slug %}">{% csrf_token %}
    <p>{% blocktrans %}This request was made under multiple information laws. If it is apparent from the reply under which law the request was answered, please choose this law below. If it is not obvious, leave it as it is.{% endblocktrans %}</p>
    {{ object.get_concrete_law_form }}
    <input type="submit" value="{% blocktrans %}Set Concrete Law{% endblocktrans %}"/>
  </form>
</div>
{% endif %}
{# endif for object.user == user and object.status_settable #}
{% endif %}

{# Postal Reply #}
{% if object.user == user and object.public_body %}
<div class="section">
  <a href="#add-postal-reply" class="toggle">{% blocktrans %}Add a Postal reply that you have received{% endblocktrans %}</a>
  <div id="add-postal-reply"{% if not postal_reply_form %} style="display: none"{% else %} class="focussed goto-form"{% endif %}>
    <form method="post" action="{% url 'foirequest-add_postal_reply' slug=object.slug %}" enctype="multipart/form-data">{% csrf_token %}
      <table class="no-stripes">
      {% if postal_reply_form %}
        {{ postal_reply_form.as_table }}
      {% else %}
      {% with form=object.get_postal_reply_form %}
      {{ form.as_table }}
      {% endwith %}
      {% endif %}
      </table>
      <input type="submit" value="{% blocktrans %}Add Postal Reply{% endblocktrans %}"/>
      <p>{% blocktrans %}You can attach more documents to this reply later.{% endblocktrans %}</p>
  </form>
  </div>
</div>
{# End Postal Reply #}

{# Reply #}
<div class="section">
  <a href="#write-message" class="toggle">{% blocktrans %}Send a reply to this Public Body{% endblocktrans %}</a>
  <div id="write-message" style="display:none">
  <form method="post" action="{% url 'foirequest-send_message' slug=object.slug %}">{% csrf_token %}
    <p>{% blocktrans %}You can send another message to this Public Body if you want to.{% endblocktrans %}</p>
    <textarea name="message"></textarea><br/>
    <input type="submit" value="{% blocktrans %}Send Message{% endblocktrans %}"/>
  </form>
  </div>
</div>
{% endif %}
{# End Reply #}


{% if object.user == user and not object.public %}
<div class="section">
  <form action="{% url 'foirequest-make_public' slug=object.slug %}" method="post">
    {% csrf_token %}
    <p>{% blocktrans %}This request is <strong>not public</strong> at the moment. You can make this request public by clicking the button below.{% endblocktrans %}<br/>
    <input type="submit" value="{% blocktrans %}Make this request public now{% endblocktrans %}"/>
    </p>
  </form>
</div>
{% endif %}

</div>
{% endblock %}

{% block extra_footer %}
<script type="text/javascript">
  $(function(){
    $("#public_body-chooser input[name='public_body']").live("change", function(e){
      Froide.app.publicBodyChosen($("#public_body-chooser input[name='public_body']:checked").val());
    });
    $("#id_status").change(function(){
      Froide.app.statusSet();
    });
    Froide.app.statusSet();
  });
</script>
{% endblock %}

